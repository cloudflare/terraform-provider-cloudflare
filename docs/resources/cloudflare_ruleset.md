---
# generated by https://github.com/hashicorp/terraform-plugin-docs
page_title: "cloudflare_ruleset Resource - Cloudflare"
subcategory: ""
description: |-
  The Cloudflare Ruleset Engine https://developers.cloudflare.com/firewall/cf-rulesets
  allows you to create and deploy rules and rulesets.
  The engine syntax, inspired by the Wireshark Display Filter language, is the
  same syntax used in custom Firewall Rules. Cloudflare uses the Ruleset Engine
  in different products, allowing you to configure several products using the same
  basic syntax.
  ~> NOTE: If you previously configured Rulesets using the dashboard,
  you first need to delete them (zone https://api.cloudflare.com/#zone-rulesets-delete-zone-ruleset,
  account https://api.cloudflare.com/#account-rulesets-delete-account-ruleset documentation)
  and clean up the resources before attempting to configure them with
  Terraform. This is because Terraform will fail to apply if configuration
  already exists to prevent blindly overwriting changes.
---

# cloudflare_ruleset (Resource)

The [Cloudflare Ruleset Engine](https://developers.cloudflare.com/firewall/cf-rulesets)
allows you to create and deploy rules and rulesets.
The engine syntax, inspired by the Wireshark Display Filter language, is the
same syntax used in custom Firewall Rules. Cloudflare uses the Ruleset Engine
in different products, allowing you to configure several products using the same
basic syntax.

~> **NOTE:** If you previously configured Rulesets using the dashboard,
you first need to delete them ([zone](https://api.cloudflare.com/#zone-rulesets-delete-zone-ruleset),
[account](https://api.cloudflare.com/#account-rulesets-delete-account-ruleset) documentation)
and clean up the resources before attempting to configure them with
Terraform. This is because Terraform will fail to apply if configuration
already exists to prevent blindly overwriting changes.

## Example Usage

```terraform
# Magic Transit
resource "cloudflare_ruleset" "magic_transit_example" {
  account_id  = "d41d8cd98f00b204e9800998ecf8427e"
  name        = "account magic transit"
  description = "example magic transit ruleset description"
  kind        = "root"
  phase       = "magic_transit"

  rules {
    action      = "allow"
    expression  = "tcp.dstport in { 32768..65535 }"
    description = "Allow TCP Ephemeral Ports"
  }
}

# Zone-level WAF Managed Ruleset
resource "cloudflare_ruleset" "zone_level_managed_waf" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "managed WAF"
  description = "managed WAF ruleset description"
  kind        = "zone"
  phase       = "http_request_firewall_managed"

  rules {
    action = "execute"
    action_parameters {
      id = "efb7b8c949ac4650a09736fc376e9aee"
    }
    expression  = "true"
    description = "Execute Cloudflare Managed Ruleset on my zone-level phase entry point ruleset"
    enabled     = true
  }
}

# Zone-level WAF with tag-based overrides
resource "cloudflare_ruleset" "zone_level_managed_waf_with_category_based_overrides" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "managed WAF with tag-based overrides"
  description = "managed WAF with tag-based overrides ruleset description"
  kind        = "zone"
  phase       = "http_request_firewall_managed"

  rules {
    action = "execute"
    action_parameters {
      id = "efb7b8c949ac4650a09736fc376e9aee"
      overrides {
        categories {
          category = "wordpress"
          action   = "block"
          enabled  = true
        }

        categories {
          category = "joomla"
          action   = "block"
          enabled  = true
        }
      }
    }

    expression  = "true"
    description = "overrides to only enable wordpress rules to block"
    enabled     = false
  }
}

# Rewrite the URI path component to a static path
resource "cloudflare_ruleset" "transform_uri_rule_path" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "transform rule for URI path"
  description = "change the URI path to a new static path"
  kind        = "zone"
  phase       = "http_request_transform"

  rules {
    action = "rewrite"
    action_parameters {
      uri {
        path {
          value = "/my-new-route"
        }
      }
    }

    expression  = "(http.host eq \"example.com\" and http.request.uri.path eq \"/old-path\")"
    description = "example URI path transform rule"
    enabled     = true
  }
}

# Rewrite the URI query component to a static query
resource "cloudflare_ruleset" "transform_uri_rule_query" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "transform rule for URI query parameter"
  description = "change the URI query to a new static query"
  kind        = "zone"
  phase       = "http_request_transform"

  rules {
    action = "rewrite"
    action_parameters {
      uri {
        query {
          value = "old=new_again"
        }
      }
    }

    expression  = "true"
    description = "URI transformation query example"
    enabled     = true
  }
}

# Rewrite HTTP headers to a modified values
resource "cloudflare_ruleset" "transform_uri_http_headers" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "transform rule for HTTP headers"
  description = "modify HTTP headers before reaching origin"
  kind        = "zone"
  phase       = "http_request_late_transform"

  rules {
    action = "rewrite"
    action_parameters {
      headers {
        name      = "example-http-header-1"
        operation = "set"
        value     = "my-http-header-value-1"
      }

      headers {
        name       = "example-http-header-2"
        operation  = "set"
        expression = "cf.zone.name"
      }

      headers {
        name      = "example-http-header-3-to-remove"
        operation = "remove"
      }
    }

    expression  = "true"
    description = "example request header transform rule"
    enabled     = false
  }
}

# HTTP rate limit for an API route
resource "cloudflare_ruleset" "rate_limiting_example" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "restrict API requests count"
  description = "apply HTTP rate limiting for a route"
  kind        = "zone"
  phase       = "http_ratelimit"

  rules {
    action = "block"
    ratelimit {
      characteristics = [
        "cf.colo.id",
        "ip.src"
      ]
      period              = 60
      requests_per_period = 100
      mitigation_timeout  = 600
    }

    expression  = "(http.request.uri.path matches \"^/api/\")"
    description = "rate limit for API"
    enabled     = true
  }
}

# Change origin for an API route
resource "cloudflare_ruleset" "http_origin_example" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "Change to some origin"
  description = "Change origin for a route"
  kind        = "zone"
  phase       = "http_request_origin"

  rules {
    action = "route"
    action_parameters {
      host_header = "some.host"
      origin = {
        host = "some.host"
        port = 80
      }
    }
    expression  = "(http.request.uri.path matches \"^/api/\")"
    description = "change origin to some.host"
    enabled     = true
  }
}

# Custom fields logging
resource "cloudflare_ruleset" "custom_fields_logging_example" {
  zone_id     = "cb029e245cfdd66dc8d2e570d5dd3322"
  name        = "log custom fields"
  description = "add custom fields to logging"
  kind        = "zone"
  phase       = "http_log_custom_fields"

  rules {
    action = "log_custom_field"
    action_parameters {
      request_fields = [
        "content-type",
        "x-forwarded-for",
        "host"
      ]
      response_fields = [
        "server",
        "content-type",
        "allow"
      ]
      cookie_fields = [
        "__ga",
        "accountNumber",
        "__cfruid"
      ]
    }

    expression  = "true"
    description = "log custom fields rule"
    enabled     = true
  }
}
```

<!-- schema generated by tfplugindocs -->

## Schema

### Required

- `kind` (String) Type of Ruleset to create. Available values: `"custom"`, `"managed"`, `"root"`, `"schema"`, `"zone"`.
- `name` (String) Name of the ruleset.
- `phase` (String) Point in the request/response lifecycle where the ruleset will be created. Available values: `"ddos_l4"`, `"ddos_l7"`, `"http_log_custom_fields"`, `"http_request_firewall_custom"`, `"http_request_firewall_managed"`, `"http_request_late_transform"`, `"http_request_main"`, `"http_request_sanitize"`, `"http_request_transform"`, `"http_request_origin"`, `"http_response_firewall_managed"`, `"http_response_headers_transform"`, `"magic_transit"`, `"http_ratelimit"`, `"http_request_sbfm"`.

### Optional

- `account_id` (String) The account identifier to target for the resource. Conflicts with `zone_id`.
- `description` (String) Brief summary of the ruleset and its intended use.
- `rules` (Block List) List of rules to apply to the ruleset. (see [below for nested schema](#nestedblock--rules))
- `shareable_entitlement_name` (String) Name of entitlement that is shareable between entities.
- `zone_id` (String) The zone identifier to target for the resource. Conflicts with `account_id`.

### Read-Only

- `id` (String) The ID of this resource.

<a id="nestedblock--rules"></a>

### Nested Schema for `rules`

Required:

- `expression` (String) Criteria for an HTTP request to trigger the ruleset rule action. Uses the Firewall Rules expression language based on Wireshark display filters. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language) documentation for all available fields, operators, and functions.

Optional:

- `action` (String) Action to perform in the ruleset rule. Available values: `"block"`, `"challenge"`, `"ddos_dynamic"`, `"execute"`, `"force_connection_close"`, `"js_challenge"`, `"managed_challenge"`, `"log"`, `"log_custom_field"`, `"rewrite"`, `"score"`, `"skip"`, `"route"`.
- `action_parameters` (Block List, Max: 1) List of parameters that configure the behavior of the ruleset rule action. (see [below for nested schema](#nestedblock--rules--action_parameters))
- `description` (String) Brief summary of the ruleset rule and its intended use.
- `enabled` (Boolean) Whether the rule is active.
- `exposed_credential_check` (Block List, Max: 1) List of parameters that configure exposed credential checks. (see [below for nested schema](#nestedblock--rules--exposed_credential_check))
- `logging` (Block List, Max: 1) List parameters to configure how the rule generates logs. (see [below for nested schema](#nestedblock--rules--logging))
- `ratelimit` (Block List, Max: 1) List of parameters that configure HTTP rate limiting behaviour. (see [below for nested schema](#nestedblock--rules--ratelimit))

Read-Only:

- `id` (String) Unique rule identifier.
- `ref` (String) Rule reference.
- `version` (String) Version of the ruleset to deploy.

<a id="nestedblock--rules--action_parameters"></a>

### Nested Schema for `rules.action_parameters`

Optional:

- `cookie_fields` (Set of String) List of cookie values to include as part of custom fields logging.
- `headers` (Block List) List of HTTP header modifications to perform in the ruleset rule. (see [below for nested schema](#nestedblock--rules--action_parameters--headers))
- `host_header` (String) Host Header that request origin receives.
- `id` (String) Identifier of the action parameter to modify.
- `increment` (Number) .
- `matched_data` (Block List, Max: 1) List of properties to configure WAF payload logging. (see [below for nested schema](#nestedblock--rules--action_parameters--matched_data))
- `origin` (Block List, Max: 1) List of properties to change request origin. (see [below for nested schema](#nestedblock--rules--action_parameters--origin))
- `overrides` (Block List, Max: 1) List of override configurations to apply to the ruleset. (see [below for nested schema](#nestedblock--rules--action_parameters--overrides))
- `phases` (Set of String) Point in the request/response lifecycle where the ruleset will be created. Available values: `"ddos_l4"`, `"ddos_l7"`, `"http_log_custom_fields"`, `"http_request_firewall_custom"`, `"http_request_firewall_managed"`, `"http_request_late_transform"`, `"http_request_main"`, `"http_request_sanitize"`, `"http_request_transform"`, `"http_request_origin"`, `"http_response_firewall_managed"`, `"http_response_headers_transform"`, `"magic_transit"`, `"http_ratelimit"`, `"http_request_sbfm"`.
- `products` (Set of String) Products to target with the actions. Available values: `"bic"`, `"hot"`, `"ratelimit"`, `"securityLevel"`, `"uablock"`, `"waf"`, `"zonelockdown"`.
- `request_fields` (Set of String) List of request headers to include as part of custom fields logging, in lowercase.
- `response` (Block List) List of parameters that configure the response given to end users. (see [below for nested schema](#nestedblock--rules--action_parameters--response))
- `response_fields` (Set of String) List of response headers to include as part of custom fields logging, in lowercase.
- `rules` (Map of String) Map of managed WAF rule ID to comma-delimited string of ruleset rule IDs. Example: `rules = { "efb7b8c949ac4650a09736fc376e9aee" = "5de7edfa648c4d6891dc3e7f84534ffa,e3a567afc347477d9702d9047e97d760" }`.
- `ruleset` (String) Which ruleset ID to target.
- `rulesets` (Set of String) List of managed WAF rule IDs to target. Only valid when the `"action"` is set to skip.
- `uri` (Block List, Max: 1) List of URI properties to configure for the ruleset rule when performing URL rewrite transformations. (see [below for nested schema](#nestedblock--rules--action_parameters--uri))
- `version` (String) Version of the ruleset to deploy.

<a id="nestedblock--rules--action_parameters--headers"></a>

### Nested Schema for `rules.action_parameters.headers`

Optional:

- `expression` (String) Use a value dynamically determined by the Firewall Rules expression language based on Wireshark display filters. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language) documentation for all available fields, operators, and functions. Conflicts with `"value"`.
- `name` (String) Name of the HTTP request header to target.
- `operation` (String) Action to perform on the HTTP request header. Available values: `"remove"`, `"set"`.
- `value` (String) Static value to provide as the HTTP request header value. Conflicts with `"expression"`.

<a id="nestedblock--rules--action_parameters--matched_data"></a>

### Nested Schema for `rules.action_parameters.matched_data`

Optional:

- `public_key` (String) Public key to use within WAF Ruleset payload logging to view the HTTP request parameters. You can generate a public key [using the `matched-data-cli` command-line tool](https://developers.cloudflare.com/waf/managed-rulesets/payload-logging/command-line/generate-key-pair) or [in the Cloudflare dashboard](https://developers.cloudflare.com/waf/managed-rulesets/payload-logging/configure).

<a id="nestedblock--rules--action_parameters--origin"></a>

### Nested Schema for `rules.action_parameters.origin`

Optional:

- `host` (String) Origin Hostname where request is sent.
- `port` (Number) Origin Port where request is sent.

<a id="nestedblock--rules--action_parameters--overrides"></a>

### Nested Schema for `rules.action_parameters.overrides`

Optional:

- `action` (String) Action to perform in the rule-level override. Available values: `"block"`, `"challenge"`, `"ddos_dynamic"`, `"execute"`, `"force_connection_close"`, `"js_challenge"`, `"managed_challenge"`, `"log"`, `"log_custom_field"`, `"rewrite"`, `"score"`, `"skip"`, `"route"`.
- `categories` (Block List) List of tag-based overrides. (see [below for nested schema](#nestedblock--rules--action_parameters--overrides--categories))
- `enabled` (Boolean) Defines if the current ruleset-level override enables or disables the ruleset.
- `rules` (Block List) List of rule-based overrides. (see [below for nested schema](#nestedblock--rules--action_parameters--overrides--rules))

<a id="nestedblock--rules--action_parameters--overrides--categories"></a>

### Nested Schema for `rules.action_parameters.overrides.rules`

Optional:

- `action` (String) Action to perform in the tag-level override. Available values: `"block"`, `"challenge"`, `"ddos_dynamic"`, `"execute"`, `"force_connection_close"`, `"js_challenge"`, `"managed_challenge"`, `"log"`, `"log_custom_field"`, `"rewrite"`, `"score"`, `"skip"`, `"route"`.
- `category` (String) Tag name to apply the ruleset rule override to.
- `enabled` (Boolean) Defines if the current tag-level override enables or disables the ruleset rules with the specified tag.

<a id="nestedblock--rules--action_parameters--overrides--rules"></a>

### Nested Schema for `rules.action_parameters.overrides.rules`

Optional:

- `action` (String) Action to perform in the rule-level override. Available values: `"block"`, `"challenge"`, `"ddos_dynamic"`, `"execute"`, `"force_connection_close"`, `"js_challenge"`, `"managed_challenge"`, `"log"`, `"log_custom_field"`, `"rewrite"`, `"score"`, `"skip"`, `"route"`.
- `enabled` (Boolean) Defines if the current rule-level override enables or disables the rule.
- `id` (String) Rule ID to apply the override to.
- `score_threshold` (Number) Anomaly score threshold to apply in the ruleset rule override. Only applicable to modsecurity-based rulesets.
- `sensitivity_level` (String) Sensitivity level for a ruleset rule override.

<a id="nestedblock--rules--action_parameters--response"></a>

### Nested Schema for `rules.action_parameters.response`

Optional:

- `content` (String) Body content to include in the response.
- `content_type` (String) HTTP content type to send in the response.
- `status_code` (Number) HTTP status code to send in the response.

<a id="nestedblock--rules--action_parameters--uri"></a>

### Nested Schema for `rules.action_parameters.uri`

Optional:

- `origin` (Boolean) .
- `path` (Block List, Max: 1) URI path configuration when performing a URL rewrite. (see [below for nested schema](#nestedblock--rules--action_parameters--uri--path))
- `query` (Block List, Max: 1) Query string configuration when performing a URL rewrite. (see [below for nested schema](#nestedblock--rules--action_parameters--uri--query))

<a id="nestedblock--rules--action_parameters--uri--path"></a>

### Nested Schema for `rules.action_parameters.uri.query`

Optional:

- `expression` (String) Expression that defines the updated (dynamic) value of the URI path or query string component. Uses the Firewall Rules expression language based on Wireshark display filters. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language) documentation for all available fields, operators, and functions.
- `value` (String) Static string value of the updated URI path or query string component.

<a id="nestedblock--rules--action_parameters--uri--query"></a>

### Nested Schema for `rules.action_parameters.uri.query`

Optional:

- `expression` (String) Expression that defines the updated (dynamic) value of the URI path or query string component. Uses the Firewall Rules expression language based on Wireshark display filters. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language) documentation for all available fields, operators, and functions.
- `value` (String) Static string value of the updated URI path or query string component.

<a id="nestedblock--rules--exposed_credential_check"></a>

### Nested Schema for `rules.exposed_credential_check`

Optional:

- `password_expression` (String) Firewall Rules expression language based on Wireshark display filters for where to check for the "password" value. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language).
- `username_expression` (String) Firewall Rules expression language based on Wireshark display filters for where to check for the "username" value. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language).

<a id="nestedblock--rules--logging"></a>

### Nested Schema for `rules.logging`

Optional:

- `enabled` (Boolean) Override the default logging behavior when a rule is matched.

<a id="nestedblock--rules--ratelimit"></a>

### Nested Schema for `rules.ratelimit`

Optional:

- `characteristics` (Set of String) List of parameters that define how Cloudflare tracks the request rate for this rule.
- `counting_expression` (String) Criteria for counting HTTP requests to trigger the Rate Limiting action. Uses the Firewall Rules expression language based on Wireshark display filters. Refer to the [Firewall Rules language](https://developers.cloudflare.com/firewall/cf-firewall-language) documentation for all available fields, operators, and functions.
- `mitigation_timeout` (Number) Once the request rate is reached, the Rate Limiting rule blocks further requests for the period of time defined in this field.
- `period` (Number) The period of time to consider (in seconds) when evaluating the request rate.
- `requests_per_period` (Number) The number of requests over the period of time that will trigger the Rate Limiting rule.
- `requests_to_origin` (Boolean) Whether to include requests to origin within the Rate Limiting count.
